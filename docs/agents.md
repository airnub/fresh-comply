title: Agent Operating Rules
version: 1.0.0
status: Locked
owners: [@airnub]
AGENT-LOCK: DO NOT EDIT THIS FILE UNLESS THE PR IS LABELED 'allow-spec-edit' AND APPROVED BY OWNERS.
---

# Coding Agent — Operating Rules

## Golden Rules (must follow)
1) **Never modify locked governance docs**:
   - `docs/specs/FreshComply-Spec.md`
   - `docs/agents.md`
   - `docs/architecture/ARD.md`
   Unless the PR is explicitly labeled **`allow-spec-edit`** and approved by owners.

2) **Tenant isolation**:
   - Do not remove `NOT NULL` from `org_id`/`tenant_org_id`.
   - Do not add policies that rely on `… IS NULL` to gate tenancy.

3) **Platform vs Tenant**:
   - Global data → `platform.*` (admin/service-role writes only).
   - Tenant data → `public.*` with `org_id NOT NULL`.

4) **RLS pattern**:
   - Tenant policy: `app.is_org_member(org_id)`
   - Admin override: `app.is_platform_admin()`
   - No client/browser writes to `platform.*`

5) **Change safety**:
   - Add SQL migrations (idempotent).
   - Update tests and CI guards when changing RLS or schemas.
   - Do not refactor unrelated code.

## Task Workflow
1) **Discover**: list impacted tables/files; confirm tenant vs platform classification.
2) **Plan**: write migration plan (backfill → constraints → policies → indexes).
3) **Implement**: SQL + minimal app code changes; keep scope tight.
4) **Test**: verify tenant vs admin behavior; run CI RLS guard.
5) **Document**: update relevant *non-locked* docs; link to this file for principles.

## Forbidden Changes
- Removing `NOT NULL` on tenant keys
- Introducing `… IS NULL` tenancy checks
- Client-side writes to `platform.*`
- Editing locked docs without the special PR label and approvals

## PR Checklist (agents must include)
- [ ] Followed RLS two-policy model
- [ ] No `IS NULL` tenancy checks introduced
- [ ] No client writes to `platform.*`
- [ ] Migrations idempotent; backfills safe
- [ ] Tests updated/passing; CI RLS guard passes
- [ ] Did **not** touch locked docs (or this PR is labeled `allow-spec-edit`)
