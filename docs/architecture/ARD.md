title: FreshComply — Architecture Requirements Document (ARD)
version: 1.0.0
status: Locked
owners: [@airnub]
AGENT-LOCK: DO NOT EDIT THIS FILE UNLESS THE PR IS LABELED 'allow-spec-edit' AND APPROVED BY OWNERS.
---

# Architecture Requirements Document (ARD)

## 1) System Overview
- **Portal (tenant UI)**: Next.js (SSR) → Supabase (RLS) → Temporal workers
- **Admin App**: server-only privileged ops; server-minted JWT with `role=platform_admin`
- **DB**: Postgres/Supabase with `public.*` (tenant) + `platform.*` (global) + `app.*` (helpers)

## 2) Functional Requirements
- Global catalogs (rule packs/sources) published by admins
- Tenant lockfiles, adoption workflows, audit trails
- Evidence export; moderation queue

## 3) Non-Functional Requirements
- **Security**: tenant isolation via RLS; admin override via claims; no client writes to `platform.*`
- **Reliability**: retries, idempotency keys, queue backpressure monitoring
- **Availability**: backups, restore drills, RPO/RTO
- **Observability**: structured logs, traces, incident response
- **Compliance**: SOC 2-aligned controls, vendor management
- **Performance**: indexes on `org_id`; pagination & caching for catalogs

## 4) Data Architecture
- `public.*` (tenant): NOT NULL `org_id`
- `platform.*` (global): admin-only write paths
- `app.*` (helpers): `app.jwt()`, `app.is_platform_admin()`, `app.is_org_member(uuid)`

## 5) Security Model
- JWT claims (server): `{ role: 'platform_admin' }` for admin app
- RLS two-policy per tenant table (member + admin)
- Platform tables: admin-only; tenants read via views/RPCs

## 6) Change Management
- Migrations only; no manual prod edits
- CI: RLS guard, client → platform write guard, test matrix
- Branch protection: main protected; 2 approvals for locked docs

## 7) Operational Runbook
- Local dev: `supabase start`, `pnpm dev`
- Temporal workers: queues, retries, dead-letter
- Incident response: on-call, severity matrix, comms templates

## 8) Diagrams (ASCII)

### 8.1 High-level
Portal ➜ API (SSR) ➜ Postgres(RLS)
                     ↘ Temporal (workers)
Admin ➜ API (SSR w/ admin JWT) ➜ Postgres(platform.* write), Temporal

### 8.2 Data Paths
Tenant read/write (public.*) → RLS(member)  
Admin read/write (public.*, platform.*) → RLS(admin)  
Tenant reads platform catalogs → views/RPCs (server)

## 9) Risks & Mitigations
- Mis-scoped policies → CI guard + reviews
- Accidental doc edits → locked governance + CODEOWNERS + CI policy
- Global/tenant confusion → platform split + spec source-of-truth

## 10) Governance
- This ARD is **locked**; edits require:
  - PR label: `allow-spec-edit`
  - Two owner approvals
  - Green CI
