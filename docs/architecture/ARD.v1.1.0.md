---
title: "Architecture Requirements Document (ARD)"
version: 1.1.0
status: Locked
---








title: FreshComply — Architecture Requirements Document (ARD)
version: 1.1.0
status: Locked
owners: [@airnub]
AGENT-LOCK: DO NOT EDIT THIS FILE UNLESS THE PR IS LABELED 'allow-spec-edit' AND APPROVED BY OWNERS.
---

# Architecture Requirements Document (ARD)

## Schema roles: public, app, platform

- public → tenant-owned data (org_id NOT NULL, RLS tenant/provider/platform patterns).
- app → helper functions/RPCs/claims; no tables with tenant/global data.
- platform → global catalogs; admin-only writes; tenants read via views/RPCs.

## Practical recommendation & scaffolding

Practical recommendation
Keep app for functions; add platform for global tables.
Your earlier design used app.is_platform_admin() and other helpers—those should stay in app. Create platform.* for global state.

Minimal SQL scaffolding (safe defaults):

-- helpers stay here
create schema if not exists app;

-- global data lives here
create schema if not exists platform;

-- example global catalog
create table if not exists platform.rule_packs (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  version text not null,
  spec jsonb not null,
  published_at timestamptz not null default now(),
  unique(name, version)
);

-- RLS: admin-only writes; tenants read via a view
alter table platform.rule_packs enable row level security;

create policy admin_read_rule_packs on platform.rule_packs
  for select using (app.is_platform_admin());

create policy admin_write_rule_packs on platform.rule_packs
  for all using (app.is_platform_admin())
  with check (app.is_platform_admin());

-- tenant-facing read-only view (optional)
create or replace view public.v_rule_packs as
  select id, name, version, spec, published_at
  from platform.rule_packs;

Client/server rule of thumb

Browser/client: never write to platform.*; read via public.v_* or server RPCs.

Admin app/server: can write platform.* using service role or a server-minted JWT with role=platform_admin.



## 1) System Overview
- **Portal (tenant UI)**: Next.js (SSR) → Supabase (RLS) → Temporal workers
- **Admin App**: server-only privileged ops; server-minted JWT with `role=platform_admin`
- **DB**: Postgres/Supabase with `public.*` (tenant) + `platform.*` (global) + `app.*` (helpers)

## 2) Functional Requirements
- Global catalogs (rule packs/sources) published by admins
- Tenant lockfiles, adoption workflows, audit trails
- Evidence export; moderation queue

## 3) Non-Functional Requirements
- **Security**: tenant isolation via RLS; admin override via claims; no client writes to `platform.*`
- **Reliability**: retries, idempotency keys, queue backpressure monitoring
- **Availability**: backups, restore drills, RPO/RTO
- **Observability**: structured logs, traces, incident response
- **Compliance**: SOC 2-aligned controls, vendor management
- **Performance**: indexes on `org_id`; pagination & caching for catalogs

## 4) Data Architecture
- `public.*` (tenant): NOT NULL `org_id`
- `platform.*` (global): admin-only write paths
- `app.*` (helpers): `app.jwt()`, `app.is_platform_admin()`, `app.is_org_member(uuid)`

## 5) Security Model
- JWT claims (server): `{ role: 'platform_admin' }` for admin app
- RLS two-policy per tenant table (member + admin)
- Platform tables: admin-only; tenants read via views/RPCs

## 6) Change Management
- Migrations only; no manual prod edits
- CI: RLS guard, client → platform write guard, test matrix
- Branch protection: main protected; 2 approvals for locked docs

## 7) Operational Runbook
- Local dev: `supabase start`, `pnpm dev`
- Temporal workers: queues, retries, dead-letter
- Incident response: on-call, severity matrix, comms templates

## 8) Diagrams (ASCII)

### 8.1 High-level
Portal ➜ API (SSR) ➜ Postgres(RLS)
                     ↘ Temporal (workers)
Admin ➜ API (SSR w/ admin JWT) ➜ Postgres(platform.* write), Temporal

### 8.2 Data Paths
Tenant read/write (public.*) → RLS(member)  
Admin read/write (public.*, platform.*) → RLS(admin)  
Tenant reads platform catalogs → views/RPCs (server)

## 9) Risks & Mitigations
- Mis-scoped policies → CI guard + reviews
- Accidental doc edits → locked governance + CODEOWNERS + CI policy
- Global/tenant confusion → platform split + spec source-of-truth

## 10) Governance
- This ARD is **locked**; edits require:
  - PR label: `allow-spec-edit`
  - Two owner approvals
  - Green CI
