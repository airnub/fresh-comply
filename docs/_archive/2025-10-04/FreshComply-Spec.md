title: FreshComply — Consolidated Product & Data Spec
version: 1.0.0
status: Locked
owners: [@airnub]
governance:
  locked_files: true
  change_process: "Only via PRs labeled 'allow-spec-edit' + 2 owner approvals"
  codeowners_required: true
  ci_policy_check: true
  branch: main
AGENT-LOCK: DO NOT EDIT THIS FILE UNLESS THE PR IS LABELED 'allow-spec-edit' AND APPROVED BY OWNERS.
---

# Archived Notice
> [!WARNING]
> Archived 2025-10-04 — Superseded by [docs/specs/freshcomply-consolidated-spec.v1.0.0.md](../../specs/freshcomply-consolidated-spec.v1.0.0.md).

# FreshComply — Consolidated Product & Data Spec

## 0) Purpose
FreshComply enables multi-tenant compliance with:
- **Freshness engine** (global catalogs → tenant lockfiles → adoption/migration)
- **Strict tenant isolation** (RLS; `org_id NOT NULL`)
- **Platform registries** (`platform.*` global catalogs, admin-only writes)
- **Audit & SOC 2 alignment** (controlled change, append-only trails, evidence export)

## 1) Scope & Glossary
- **Tenant/Org**: a customer container
- **Platform admin**: privileged operator (server-minted JWT with `role=platform_admin`)
- **Platform registries**: canonical catalogs used by many tenants
- **Lockfile**: immutable capture of versions/config at a point-in-time

## 2) Tenancy Model
- All **tenant tables in `public.*`** carry **`org_id uuid NOT NULL`**.
- RLS: **member OR admin**:
  - `app.is_org_member(org_id)` for tenant access
  - `app.is_platform_admin()` for admin override
- No policy may depend on “`… IS NULL`” for tenancy gating.

## 3) Platform Model
- **Global data** in `platform.*`:
  - `platform.rule_sources`, `platform.rule_packs` (versioned, published)
  - `platform.rule_pack_detections`, `platform.rule_pack_proposals` (moderation)
  - `platform.step_types` (optional registry)
- Writes: **admin/service-role only**.  
- Tenants **read** via **server RPCs** or **read-only views** (`public.v_*`)—never direct writes.

## 4) Freshness Engine
- **Detect** changes in `platform.rule_sources` → create **detections** and **proposals**
- **Moderate** proposals (admin) → **publish** rule pack versions
- **Lockfile** capture per tenant workflow at run/define time (immutable)
- **Adoption** flow compares lockfile vs newest platform version, records adoption with actor, strategy & changelog checksum

## 5) Data Model (key tables)
**Tenant (`public.*`):**
- `orgs`, `org_memberships`
- `workflow_defs`, `workflow_lockfiles`, `workflow_lock_adoptions`
- `runs`, `run_steps`, `documents`, `audits`

**Platform (`platform.*`):**
- `rule_sources`, `rule_packs`
- `rule_pack_detections`, `rule_pack_proposals`
- `step_types`

## 6) Security / RLS
- Helpers in `app` schema:
  - `app.jwt()`, `app.is_platform_admin()`, `app.is_org_member(uuid)`
- Two-policy model for tenant tables:
  - **Tenant**: `using/with check app.is_org_member(org_id)`
  - **Admin**: `using/with check app.is_platform_admin()`
- Platform tables:
  - Enable RLS; allow **admin** read/write; tenant access via **views/RPCs** only.

## 7) Change Control & CI
- CI blocks: any RLS that checks `org_id IS NULL` or `parent_org_id IS NULL`
- CI blocks: any client/browser path attempting to **write** to `platform.*`
- PR template: explicit checkbox “This PR edits locked governance docs” (must be labeled)
- Branch protections: main is protected; 2 approvals required for locked files

## 8) SOC 2 Alignment (highlights)
- **Access control**: least-privilege, admin override via server claims, quarterly reviews
- **Change mgmt**: PRs, required reviews, CI gates, tagged releases
- **Auditability**: append-only trails, reason codes, 2-person approval (where needed)
- **Availability**: backups, restore drills, RPO/RTO documented
- **Vuln mgmt**: scanning, patching, dependency inventory
- **Privacy/Confidentiality** (if in scope): catalog, retention, DSAR, secure disposal

## 9) Migrations
- Reassert **NOT NULL** on tenant keys; move any prior “global” rows to `platform.*`
- Index `(org_id, …)` on all tenant tables; verify no NULLs before constraint

## 10) Non-Goals
- No tenant scope implemented via NULL orgs
- No browser/client writes to `platform.*`

## 11) Versioning
- This file is **locked**. Updates require:
  1) PR label: `allow-spec-edit`
  2) Two owner approvals
  3) Green CI (policy checks)
