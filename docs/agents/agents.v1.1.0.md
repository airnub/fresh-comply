---
title: "Coding Agent — Operating Rules"
version: 1.1.0
status: Locked
---








title: Agent Operating Rules
version: 1.1.0
status: Locked
owners: [@airnub]
AGENT-LOCK: DO NOT EDIT THIS FILE UNLESS THE PR IS LABELED 'allow-spec-edit' AND APPROVED BY OWNERS.
---

# Coding Agent — Operating Rules

## Schema roles: public, app, platform

**Platform schema guardrails**

- Never store data in app.*. Put global data in platform.*.
- Never generate client code that writes to platform.*.
- If a global catalog is needed, create it under platform.* and expose read-only via public.v_* or server RPC.

- public → tenant-owned data (org_id NOT NULL, RLS tenant/provider/platform patterns).
- app → helper functions/RPCs/claims; no tables with tenant/global data.
- platform → global catalogs; admin-only writes; tenants read via views/RPCs.

## Practical recommendation & scaffolding

Practical recommendation
Keep app for functions; add platform for global tables.
Your earlier design used app.is_platform_admin() and other helpers—those should stay in app. Create platform.* for global state.

Minimal SQL scaffolding (safe defaults):

-- helpers stay here
create schema if not exists app;

-- global data lives here
create schema if not exists platform;

-- example global catalog
create table if not exists platform.rule_packs (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  version text not null,
  spec jsonb not null,
  published_at timestamptz not null default now(),
  unique(name, version)
);

-- RLS: admin-only writes; tenants read via a view
alter table platform.rule_packs enable row level security;

create policy admin_read_rule_packs on platform.rule_packs
  for select using (app.is_platform_admin());

create policy admin_write_rule_packs on platform.rule_packs
  for all using (app.is_platform_admin())
  with check (app.is_platform_admin());

-- tenant-facing read-only view (optional)
create or replace view public.v_rule_packs as
  select id, name, version, spec, published_at
  from platform.rule_packs;

Client/server rule of thumb

Browser/client: never write to platform.*; read via public.v_* or server RPCs.

Admin app/server: can write platform.* using service role or a server-minted JWT with role=platform_admin.



## Golden Rules (must follow)
1) **Never modify locked governance docs**:
   - `docs/specs/FreshComply-Spec.md`
   - `docs/agents/agents.v1.0.0.md`
   - `docs/architecture/ARD.v1.0.0.md`
   Unless the PR is explicitly labeled **`allow-spec-edit`** and approved by owners.

2) **Tenant isolation**:
   - Do not remove `NOT NULL` from `org_id`/`tenant_org_id`.
   - Do not add policies that rely on `… IS NULL` to gate tenancy.

3) **Platform vs Tenant**:
   - Global data → `platform.*` (admin/service-role writes only).
   - Tenant data → `public.*` with `org_id NOT NULL`.

4) **RLS pattern**:
   - Tenant policy: `app.is_org_member(org_id)`
   - Admin override: `app.is_platform_admin()`
   - No client/browser writes to `platform.*`

5) **Change safety**:
   - Add SQL migrations (idempotent).
   - Update tests and CI guards when changing RLS or schemas.
   - Do not refactor unrelated code.

## Task Workflow
1) **Discover**: list impacted tables/files; confirm tenant vs platform classification.
2) **Plan**: write migration plan (backfill → constraints → policies → indexes).
3) **Implement**: SQL + minimal app code changes; keep scope tight.
4) **Test**: verify tenant vs admin behavior; run CI RLS guard.
5) **Document**: update relevant *non-locked* docs; link to this file for principles.

## Forbidden Changes
- Removing `NOT NULL` on tenant keys
- Introducing `… IS NULL` tenancy checks
- Client-side writes to `platform.*`
- Editing locked docs without the special PR label and approvals

## PR Checklist (agents must include)
- [ ] Followed RLS two-policy model
- [ ] No `IS NULL` tenancy checks introduced
- [ ] No client writes to `platform.*`
- [ ] Migrations idempotent; backfills safe
- [ ] Tests updated/passing; CI RLS guard passes
- [ ] Did **not** touch locked docs (or this PR is labeled `allow-spec-edit`)
